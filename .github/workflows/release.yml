name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_release:
        description: 'Build artifacts only (no GitHub release)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

env:
  # Grammar repos and their source directories
  GRAMMARS: |
    go:tree-sitter/tree-sitter-go:master:src
    python:tree-sitter/tree-sitter-python:master:src
    javascript:tree-sitter/tree-sitter-javascript:master:src
    typescript:tree-sitter/tree-sitter-typescript:master:typescript/src
    rust:tree-sitter/tree-sitter-rust:master:src
    ruby:tree-sitter/tree-sitter-ruby:master:src
    c:tree-sitter/tree-sitter-c:master:src
    cpp:tree-sitter/tree-sitter-cpp:master:src
    java:tree-sitter/tree-sitter-java:master:src
    swift:tree-sitter/tree-sitter-swift:master:src
    bash:tree-sitter/tree-sitter-bash:master:src
    kotlin:fwcd/tree-sitter-kotlin:main:src
    c_sharp:tree-sitter/tree-sitter-c-sharp:master:src
    php:tree-sitter/tree-sitter-php:master:php/src
    dart:UserNobody14/tree-sitter-dart:master:src
    r:r-lib/tree-sitter-r:main:src

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - runner: macos-13
            goarch: amd64
            name: codemap-darwin-amd64
          - runner: macos-14
            goarch: arm64
            name: codemap-darwin-arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build Go binary
        env:
          CGO_ENABLED: 1
        run: go build -o codemap .

      - name: Build grammars
        run: |
          mkdir -p grammars

          echo "$GRAMMARS" | while IFS=: read -r lang repo branch src_dir; do
            [ -z "$lang" ] && continue
            echo "Building $lang..."

            curl -sL "https://github.com/$repo/archive/refs/heads/$branch.tar.gz" | tar xz
            extracted_dir=$(ls -d */ 2>/dev/null | head -1)
            src_path="${extracted_dir}${src_dir}"

            if [ ! -d "$src_path" ]; then
              echo "  ✗ Source not found"
              rm -rf "$extracted_dir"
              continue
            fi

            sources="$src_path/parser.c"
            if [ -f "$src_path/scanner.c" ]; then
              sources="$sources $src_path/scanner.c"
            elif [ -f "$src_path/scanner.cc" ]; then
              clang++ -c -fPIC -I"$src_path" "$src_path/scanner.cc" -o scanner.o
              sources="$sources scanner.o"
            fi

            clang -shared -fPIC -I"$src_path" $sources -o "grammars/libtree-sitter-$lang.dylib"
            rm -rf "$extracted_dir" scanner.o 2>/dev/null

            [ -f "grammars/libtree-sitter-$lang.dylib" ] && echo "  ✓ Built" || echo "  ✗ Failed"
          done

          ls -la grammars/

      - name: Create release archive
        run: |
          mkdir -p release/${{ matrix.name }}
          cp codemap release/${{ matrix.name }}/
          cp -r grammars release/${{ matrix.name }}/
          cp -r scanner/queries release/${{ matrix.name }}/
          cat > release/${{ matrix.name }}/README.txt << 'EOF'
          codemap - Generate a brain map of your codebase for LLM context

          Usage:
            codemap .              # Project structure
            codemap --deps         # Dependency flow
            codemap --diff         # Changed files vs main

          Keep grammars/ next to codemap, or set CODEMAP_GRAMMAR_DIR.
          More info: https://github.com/JordanCoin/codemap
          EOF
          cd release && tar -czvf ../${{ matrix.name }}.tar.gz ${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}.tar.gz

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goarch: amd64
            name: codemap-linux-amd64
          - goarch: arm64
            cc: aarch64-linux-gnu-gcc
            name: codemap-linux-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install cross-compiler
        if: matrix.goarch == 'arm64'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build Go binary
        env:
          CGO_ENABLED: 1
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          CC: ${{ matrix.cc || 'gcc' }}
        run: go build -o codemap .

      - name: Build grammars
        run: |
          mkdir -p grammars
          CC="${{ matrix.cc || 'gcc' }}"

          echo "$GRAMMARS" | while IFS=: read -r lang repo branch src_dir; do
            [ -z "$lang" ] && continue
            echo "Building $lang..."

            curl -sL "https://github.com/$repo/archive/refs/heads/$branch.tar.gz" | tar xz
            extracted_dir=$(ls -d */ 2>/dev/null | head -1)
            src_path="${extracted_dir}${src_dir}"

            if [ ! -d "$src_path" ]; then
              echo "  ✗ Source not found"
              rm -rf "$extracted_dir"
              continue
            fi

            sources="$src_path/parser.c"
            if [ -f "$src_path/scanner.c" ]; then
              sources="$sources $src_path/scanner.c"
            elif [ -f "$src_path/scanner.cc" ]; then
              ${CC/gcc/g++} -c -fPIC -I"$src_path" "$src_path/scanner.cc" -o scanner.o 2>/dev/null || \
              g++ -c -fPIC -I"$src_path" "$src_path/scanner.cc" -o scanner.o
              sources="$sources scanner.o"
            fi

            $CC -shared -fPIC -I"$src_path" $sources -o "grammars/libtree-sitter-$lang.so" 2>/dev/null || echo "  Warning: build issue"
            rm -rf "$extracted_dir" scanner.o 2>/dev/null

            [ -f "grammars/libtree-sitter-$lang.so" ] && echo "  ✓ Built" || echo "  ✗ Failed"
          done

          ls -la grammars/

      - name: Create release archive
        run: |
          mkdir -p release/${{ matrix.name }}
          cp codemap release/${{ matrix.name }}/
          cp -r grammars release/${{ matrix.name }}/
          cp -r scanner/queries release/${{ matrix.name }}/
          cat > release/${{ matrix.name }}/README.txt << 'EOF'
          codemap - Generate a brain map of your codebase for LLM context

          Usage:
            codemap .              # Project structure
            codemap --deps         # Dependency flow
            codemap --diff         # Changed files vs main

          Keep grammars/ next to codemap, or set CODEMAP_GRAMMAR_DIR.
          More info: https://github.com/JordanCoin/codemap
          EOF
          cd release && tar -czvf ../${{ matrix.name }}.tar.gz ${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}.tar.gz

  build-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Create zig wrapper
        run: |
          mkdir -p "$HOME/zigcc"
          cat > "$HOME/zigcc/zcc" << 'SCRIPT'
          #!/bin/sh
          zig cc -target x86_64-windows-gnu "$@"
          SCRIPT
          cat > "$HOME/zigcc/zxx" << 'SCRIPT'
          #!/bin/sh
          zig c++ -target x86_64-windows-gnu "$@"
          SCRIPT
          chmod +x "$HOME/zigcc/zcc" "$HOME/zigcc/zxx"

      - name: Build Go binary
        env:
          CGO_ENABLED: 1
          GOOS: windows
          GOARCH: amd64
          CC: /home/runner/zigcc/zcc
          CXX: /home/runner/zigcc/zxx
        run: go build -ldflags="-s -w" -o codemap.exe .

      - name: Build grammars
        run: |
          mkdir -p grammars

          echo "$GRAMMARS" | while IFS=: read -r lang repo branch src_dir; do
            [ -z "$lang" ] && continue
            echo "Building $lang..."

            curl -sL "https://github.com/$repo/archive/refs/heads/$branch.tar.gz" | tar xz
            extracted_dir=$(ls -d */ 2>/dev/null | head -1)
            src_path="${extracted_dir}${src_dir}"

            if [ ! -d "$src_path" ]; then
              echo "  ✗ Source not found"
              rm -rf "$extracted_dir"
              continue
            fi

            sources="$src_path/parser.c"
            if [ -f "$src_path/scanner.c" ]; then
              sources="$sources $src_path/scanner.c"
            elif [ -f "$src_path/scanner.cc" ]; then
              zig c++ -target x86_64-windows-gnu -c -fPIC -I"$src_path" "$src_path/scanner.cc" -o scanner.o 2>/dev/null || echo "  Warning: C++ issue"
              [ -f scanner.o ] && sources="$sources scanner.o"
            fi

            zig cc -target x86_64-windows-gnu -shared -fPIC -I"$src_path" $sources -o "grammars/libtree-sitter-$lang.dll" 2>/dev/null || echo "  Warning: build issue"
            rm -rf "$extracted_dir" scanner.o 2>/dev/null

            [ -f "grammars/libtree-sitter-$lang.dll" ] && echo "  ✓ Built" || echo "  ✗ Failed"
          done

          ls -la grammars/

      - name: Create release archive
        run: |
          mkdir -p release/codemap-windows-amd64
          cp codemap.exe release/codemap-windows-amd64/
          cp -r grammars release/codemap-windows-amd64/
          cp -r scanner/queries release/codemap-windows-amd64/
          cat > release/codemap-windows-amd64/README.txt << 'EOF'
          codemap - Generate a brain map of your codebase for LLM context

          Usage:
            codemap .              # Project structure
            codemap --deps         # Dependency flow
            codemap --diff         # Changed files vs main

          Keep grammars/ next to codemap.exe, or set CODEMAP_GRAMMAR_DIR.
          More info: https://github.com/JordanCoin/codemap
          EOF
          cd release && zip -r ../codemap-windows-amd64.zip codemap-windows-amd64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codemap-windows-amd64
          path: codemap-windows-amd64.zip

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.skip_release == false)
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
          generate_release_notes: true
